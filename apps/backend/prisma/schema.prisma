generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id                                          String            @id
  email                                       String            @unique
  name                                        String?
  phone                                       String?           @unique
  password_hash                               String            @map("password_hash")
  role                                        UserRole          @default(STUDENT)
  is_verified                                 Boolean           @default(false)
  is_active                                   Boolean           @default(true)
  created_at                                  DateTime          @default(now())
  updated_at                                  DateTime          @updatedAt

  admin_audits                                AdminAudit[]
  applications                                Application[]
  booking_fees_student                        BookingFee[]      @relation("booking_fees_student_idTousers")
  booking_fees_tutor                          BookingFee[]      @relation("booking_fees_tutor_idTousers")
  documents_reviewed                          Document[]        @relation("documents_reviewed_byTousers")
  documents                                   Document[]        @relation("documents_user_idTousers")
  notifications                               Notification[]
  otp_codes                                   OtpCode[]
  refresh_tokens                              RefreshToken[]
  reviews_as_student                          Review[]          @relation("reviews_student_idTousers")
  reviews_as_tutor                            Review[]          @relation("TutorReviews")
  student_profile                             StudentProfile?
  tuition_requests                            TuitionRequest[]
  tutor_posts                                 TutorPost[]
  tutor_profile                               TutorProfile?

  @@map("users")
}

model TuitionRequest {
  id               String         @id @default(cuid())
  studentId        String         @map("student_id")
  title            String
  description      String
  subject          String
  level            String?
  mode             String?
  location         String?
  budget           Decimal?       @db.Decimal(10, 2)
  duration         Int?
  schedule         Json?
  status           RequestStatus  @default(OPEN)
  contact_unlocked Boolean        @default(false)
  deadline         DateTime?
  createdAt        DateTime       @default(now()) @map("created_at")
  updatedAt        DateTime       @updatedAt @map("updated_at")
  closed_at        DateTime?

  applications     Application[]
  booking_fees     BookingFee[]
  reviews          Review[]
  student          User           @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@index([status])
  @@index([studentId])
  @@index([subject])
  @@map("tuition_requests")
}

model Application {
  id            String            @id @default(cuid())
  requestId     String            @map("request_id")
  tutorId       String            @map("tutor_id")
  message       String?
  proposed_rate Decimal?          @db.Decimal(10, 2)
  status        ApplicationStatus @default(PENDING)
  createdAt     DateTime          @default(now()) @map("created_at")
  updatedAt     DateTime          @updatedAt @map("updated_at")
  responded_at  DateTime?

  request       TuitionRequest    @relation(fields: [requestId], references: [id], onDelete: Cascade)
  tutor         User              @relation(fields: [tutorId], references: [id], onDelete: Cascade)

  @@unique([requestId, tutorId])
  @@index([status])
  @@map("applications")
}

model Review {
  id                    String         @id @default(cuid())
  tuition_request_id    String
  studentId             String         @map("student_id")
  tutorId               String         @map("tutor_id")
  rating                Int
  comment               String?
  createdAt             DateTime       @default(now()) @map("created_at")
  updated_at            DateTime       @updatedAt

  student               User           @relation("reviews_student_idTousers", fields: [studentId], references: [id], onDelete: Cascade)
  tuition_request       TuitionRequest @relation(fields: [tuition_request_id], references: [id], onDelete: Cascade)
  tutor                 User           @relation("TutorReviews", fields: [tutorId], references: [id], onDelete: Cascade)

  @@unique([tuition_request_id, studentId])
  @@index([tutorId])
  @@map("reviews")
}

model AdminAudit {
  id          String   @id
  admin_id    String
  action      String
  target_type String
  target_id   String
  metadata    Json?
  created_at  DateTime @default(now())

  admin       User     @relation(fields: [admin_id], references: [id], onDelete: Cascade)

  @@index([admin_id])
  @@index([target_type, target_id])
  @@map("admin_audits")
}

model BookingFee {
  id                 String         @id
  tuition_request_id String
  student_id         String
  tutor_id           String
  amount             Int
  payment_method     String
  transaction_id     String?
  status             BookingStatus  @default(PENDING)
  rejection_reason   String?
  submitted_at       DateTime?
  verified_at        DateTime?
  rejected_at        DateTime?
  created_at         DateTime       @default(now())
  updated_at         DateTime       @updatedAt

  student            User           @relation("booking_fees_student_idTousers", fields: [student_id], references: [id], onDelete: Cascade)
  tuition_request    TuitionRequest @relation(fields: [tuition_request_id], references: [id], onDelete: Cascade)
  tutor              User           @relation("booking_fees_tutor_idTousers", fields: [tutor_id], references: [id], onDelete: Cascade)

  @@index([status])
  @@index([student_id])
  @@index([tuition_request_id])
  @@index([tutor_id])
  @@map("booking_fees")
}

model Document {
  id          String         @id
  user_id     String
  type        String
  file_url    String
  status      DocumentStatus @default(PENDING)
  reason      String?
  reviewed_by String?
  reviewed_at DateTime?
  created_at  DateTime       @default(now())
  updated_at  DateTime       @updatedAt

  reviewer    User?          @relation("documents_reviewed_byTousers", fields: [reviewed_by], references: [id])
  user        User           @relation("documents_user_idTousers", fields: [user_id], references: [id], onDelete: Cascade)

  @@index([status])
  @@index([user_id])
  @@map("documents")
}

model Notification {
  id         String           @id
  user_id    String
  type       NotificationType
  title      String
  message    String
  data       Json?
  is_read    Boolean          @default(false)
  created_at DateTime         @default(now())

  user       User             @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([user_id, is_read])
  @@map("notifications")
}

model OtpCode {
  id         String     @id
  phone      String
  code       String
  purpose    OTPPurpose
  expires_at DateTime
  used_at    DateTime?
  created_at DateTime   @default(now())
  userId     String?

  user       User?      @relation(fields: [userId], references: [id])

  @@index([phone, purpose])
  @@map("otp_codes")
}

model RefreshToken {
  id         String    @id
  token      String    @unique
  user_id    String
  expires_at DateTime
  created_at DateTime  @default(now())
  revoked_at DateTime?

  user       User      @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@map("refresh_tokens")
}

model StudentProfile {
  id            String   @id
  user_id       String   @unique
  grade         String?
  school        String?
  subjects      String[]
  goals         String?
  preferredMode String?
  location      String?
  budget        Decimal? @db.Decimal(10, 2)
  created_at    DateTime @default(now())
  updated_at    DateTime @updatedAt

  user          User     @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@map("student_profiles")
}

model TutorPost {
  id           String   @id
  tutor_id     String
  title        String
  description  String
  subject      String
  level        String?
  hourly_rate  Decimal  @db.Decimal(10, 2)
  mode         String?
  location     String?
  availability Json?
  is_active    Boolean  @default(true)
  views        Int      @default(0)
  created_at   DateTime @default(now())
  updated_at   DateTime @updatedAt

  tutor        User     @relation(fields: [tutor_id], references: [id], onDelete: Cascade)

  @@index([is_active])
  @@index([subject])
  @@index([tutor_id])
  @@map("tutor_posts")
}

model TutorProfile {
  id             String   @id
  user_id        String   @unique
  bio            String?
  education      String?
  experience     Int      @default(0)
  hourly_rate    Decimal  @db.Decimal(10, 2)
  subjects       String[]
  qualifications String[]
  availability   Json?
  is_verified    Boolean  @default(false)
  average_rating Decimal? @db.Decimal(3, 2)
  total_reviews  Int      @default(0)
  total_students Int      @default(0)
  total_hours    Int      @default(0)
  location       String?
  is_online      Boolean  @default(false)
  created_at     DateTime @default(now())
  updated_at     DateTime @updatedAt

  user           User     @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@map("tutor_profiles")
}

enum UserRole {
  STUDENT
  TUTOR
  ADMIN
}

enum ApplicationStatus {
  PENDING
  ACCEPTED
  REJECTED
  WITHDRAWN
}

enum BookingStatus {
  PENDING
  SUBMITTED
  VERIFIED
  REJECTED
}

enum DocumentStatus {
  PENDING
  APPROVED
  REJECTED
}

enum NotificationType {
  NEW_APPLICATION
  APPLICATION_ACCEPTED
  APPLICATION_REJECTED
  NEW_MESSAGE
  SESSION_REMINDER
  SYSTEM
  PAYMENT_SUBMITTED
  PAYMENT_VERIFIED
  PAYMENT_REJECTED
}

enum OTPPurpose {
  VERIFY_PHONE
  LOGIN
  RESET_PASSWORD
}

enum RequestStatus {
  OPEN
  IN_PROGRESS
  ASSIGNED
  CLOSED
  CANCELLED
}
